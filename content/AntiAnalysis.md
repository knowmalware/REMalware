# Anti-Analysis

## Anti-Debug

### Debugger Flags
Since there are legitmate reasons to detect a debugger (e.g. Debug Print), Windows leaves flags in each process that tell a process it's being debugged. Additionally, some API functions also reveal this information. Some examples:
- `PEB!IsDebugged` flag is a common check:
    ```asm
        mov eax, fs:[30]
        mov eax, [eax+2]
        test eax, eax
        jnz exit_debugger_detected
    ```
- `kernel32!IsDebuggerPresent` function
- `ntdll!NtQueryInformationProcess` with `ProcessInformationClass` argument of 7 (`ProcessDebugPort`)
    ```
        NTSYSAPI NTSTATUS NTAPI NtQueryInformationProcess(
            IN HANDLE ProcessHandle,
            IN PROCESS_INFORMATION_CLASS ProcessInformationClass,
            OUT PVOID ProcessInformation,
            IN ULONG ProcessInformationLength,
            OUT PULONG ReturnLength
        );
    ```

### Thwarting Debugger Checks
At the most basic level, debugger checks can be evaded by altering debug flags or API return values in memory/registers. Some tools are provided to silently handle SOME of these checks for us:

- Ollydbg's Olly Advanced
- [Immunity Debug's `hidedebug.py` plugin](https://github.com/kbandla/ImmunityDebugger/blob/master/1.83/PyCommands/hidedebug.py) can fool many common anti-debug checks
- [IDAStealth Plugin](https://github.com/nihilus/idastealth)
- [ScyllaHide](https://github.com/x64dbg/ScyllaHide)
    - Can be used as a plugin (OllyDbg, x64dbg, IDA v6) or as a standalone application that injects into a debugger.

### Exercise
If you have [Practical Malware Analysis](https://nostarch.com/malware), try [Lab16-01](http://practicalmalwareanalysis.com/labs/).


## Timing Checks

Execution in debuggers, virtual machines, and emulators have overhead that can slow processing; a delay which can be detected.

- `GetTickCount` or `QueryPerformanceCounter` calls
- `RDTSC` instructions (Read Time Stamp Counter)
    - They generally come in pairs, followed by a comparison.  For example:
        ```asm
            rdtsc
            mov ebx, eax
              ... some measured code ...
            rdtsc
            sub eax, ebx
            cmp eax, ... some tick count ...
            jg detected_debugger
        ```

The following script can be used with IDA to add visual cues for "interesting" instructions.

```
    #include <idc.idc>

    static main() {
        auto start, end, addr, mnem, count, opnd, opnd1, opnd2;
        start = SegStart( ScreenEA() );
        end = SegEnd( ScreenEA() );
        addr = start;
        count = 0;
        while( addr < end ) {
            mnem = GetMnem( addr );
            // Common VM detect instructions
            if( mnem == "sidt" || mnem == "sgdt" || mnem == "sldt" || mnem == "smsw" || mnem == "str" ) {
                Message( "%08x: Found %s\n", addr, mnem );
                SetColor( addr, CIC_ITEM, 0x0088ff ); // orange
            }
            // Read Time Stamp Counter
            if( mnem == "rdtsc" ) {
                Message( "%08x: Found %s\n", addr, mnem );
                SetColor( addr, CIC_ITEM, 0xff8800 ); // blue
            }
            // Exception Handling or other PEB/TEB access
            opnd = "";
            opnd1 = GetOpnd( addr, 0 );
            opnd2 = GetOpnd( addr, 1 );
            if( strstr( opnd1, "fs:" ) > -1 ) {
                opnd = opnd1;
            }
            else {
                if( strstr( opnd2, "fs:" ) > -1 ) opnd = opnd2;
            }
            if( opnd != "" ) {
                Message( "%08x: Found %s\n", addr, opnd );
                SetColor( addr, CIC_ITEM, 0xff8888 ); // purple
            }
            addr = NextHead( addr, BADADDR );
            count = count + 1;
        }
        Message( "Processed %d instructions from %08x to %08x\n", count, start, end );
    }
```


## Structured Exception Handling

- Can be identified by reads/writes to `FS:[0]`
- This is the beginning of the Thread Environment Block (TEB), first member of which is `PEXCEPTION_REGISTRATION_RECORD` ExceptionList
    ```c
        typedef struct _EXCEPTION_REGISTRATION_RECORD
        {
             PEXCEPTION_REGISTRATION_RECORD Next;
             PEXCEPTION_DISPOSITION Handler;
        } EXCEPTION_REGISTRATION_RECORD, *PEXCEPTION_REGISTRATION_RECORD;
    ```
    - This points the the beginning of the structured exception handler list.
- Be aware of intentional exceptions, for example:
    ```asm
        xor eax, eax
        mov [eax], ecx
    ```
- Debuggers can be configured to pass exceptions to the debuggee.


## Anti-Dump

- Accomplished by preventing access to files/memory
    - `CreateFileA` with `dwShareMode` of 0 can prevent file access
- OllyDumpEx must be able to read the PE file headers to succeed


## Anti-VM

### Overview
- RedPill uses SIDT (a very uncommon instruction) to detect a VM
    - VMs have to use a different Interrupt Descriptor Table address than the host system
- Other detections may search for VM software artifacts (e.g. VMware Tools)

### Exercise
If you have [Practical Malware Analysis](https://nostarch.com/malware), try [Lab17-01](http://practicalmalwareanalysis.com/labs/).
