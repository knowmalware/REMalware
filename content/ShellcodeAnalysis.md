# Shellcode Analysis

## About

Shellcode is a small segment of code that is often used by software exploits as payload. Shellcode:
- is typically position independent
- generally begins with a series of literal or functional nop instructions
- most likely loads the API functions it requires
- might be written repeatedly to the heap to increase success rate (Heap Spray)
- can often be found in the following file types (and [others](https://cve.mitre.org/cve/data_feeds.html))
  - PDF (CVE-2011-2462)
  - Javascript in PDF (CVE-2009-4324)
  - MS-Office document (CVE-2009-3129)
  - Flash object (CVE-2012-0754)
  - Flash object in PDF (CVE-2011-0611)
  - Flash object in MS-Office document (CVE-2012-0754)
  - RTF (CVE-2010-3333)
  - Java (CVE-2011-3521)
  - Compiled HTML Help / CHM
- May be nested in objects or files stored in the delivery file (e.g. PDF with JavaScript or Flash)
- Shellcode objects may be encoded (e.g. PDF FlateEncoded streams)

### Purpose
Shellcode is generally use in the first stage of an attack. It often delivers and executes a payload which then does the bulk of the dirty work. First stage shellcode will come in one of two forms:

### Downloaders
*Downloader* shellcode attempts to retrieve and execute a malware file requiring Internet access at time of exploitation.

### Droppers
*Dropper* shellcode extracts and executes a file contained within the exploit file. The shellcode often has to decode this payload. Though no network connection is required, this provides more information for detection and analysis.


## Extraction

Chapter 19 in [Practical Malware Analysis](https://nostarch.com/malware) provides a detailed explanation of typical shellcode techniques and provides a helpful debugging utility. It also provides suggestions for how to identify shellcode blobs (pp423-424). However, it does not describe how to extract the shellcode from the various containers, so we will show you here. This one topic could be a whole course itself, so we will only be looking at Javascript-in-a-PDF for the example and for the lab.

We will extract shellcode from `CVE-2007-5659_PDF__9BC1735453963E33EA1857CC25AA5A19_SurveyOnObamapdf.pdf=` using the following process:
1. Start [PDFStreamDumper](http://sandsprite.com/blogs/index.php?uid=7&pid=57)
1. Load -> Pdf File
1. View objects list in left-side box
  - Tools -> **About Listview Colors**
1. choose object of interest (click on it to select)
  - to export as-is: Right-click object number in left-side box and choose **Save Raw Stream**
  - to deal with JavaScript...
    1. click on object in left-side box, to select it
    1. click `Javascrip_UI` (in the menubar)
    1. modify the code so that you remove the exploit line(s) and just have a variable that contains the shellcode
    1. add to the end of the JavaScript box (replacing *VARNAME* with the varible): `tb.writeFile("C:\\shellcode.bin",VARNAME)`
    1. click the **Run** button


## Analysis

When analyzing the shellcode itself, it helps to know a basic loading technique that relies on the fact that `kernel32.dll` [is always loaded into the memory space of an MS-Windows process](http://blog.harmonysecurity.com/2009_08_01_archive.html). The shellcode must find `kernel32.dll` in memory and then identify the locations of any API calls it wants to use from the DLL. `LoadLibraryA` can be used to then load additional DLLs and access other APIs. This is explained quite well in [Practical Malware Analysis](https://nostarch.com/malware), so if you have the book, refer to Figure 19-1 on p414 and Listing 19-6 on p419.

EXAMPLE:

- A walk through the previously extracted shellcode from `CVE-2007-5659_PDF__9BC1735453963E33EA1857CC25AA5A19_SurveyOnObamapdf.pdf=`.


## Egg Hunt

Shellcode sometimes needs to drop additional malware on the system. To do this, it will either download the additional malware, or it will decode the additional drop file(s) from the initial infection vector, i.e. the PDF or DOC. If the additional files are embedded in the same file that the shellcode was embedded, then the shellcode will need to find the additional file(s) somehow. This search for additional embedded malicious object(s) is called the Egg Hunt.

There are various techniques to an Egg Hunt, but the most common is to obtain an open handle to the file on disk or to the memory space of the process that has already loaded the file. The shellcode then searches for a unique byte sequence that identifies the start of the additional embedded malicious object(s). Often this is a four-byte sequence, which is easier to include in minimalist shellcode and often unique enough for a single file or process' memory.


## Exercises
1. Reproduce extracting shellcode and analysis using the previous Example.
1. *ADVANCED*: Duplicate process with `CVE-2009-4324_PDF_43CB55861B7FCF1DFB6968C9EF110BCC_Aug2010.pdf=`, from contagiodump.blogspot.com, using additional resources:
  - ASCII table printout
  - kernel32 exports hashes database
  - `xor.idc` script


## Summary
1. File format exploitation is popular.
1. Many file formats allow embedded objects and numerous encoding types
1. Identify, extract, and decode potential exploitation objects using tools specific to the file format
1. From that point, most shellcode follows these basic mechanics:
  1. find kernel32 in memory
  1. find `LoadLibraryA`
  1. build the shellcode-equivalent of an IAT
  1. drop an embedded payload or download additional malware
