# Execution and Persistence

## About

Often malware is packaged up into a tool akin to an installer which may use any of the many windows methods for code execution amd persistence. Some common forms are:

- **Dropper**: Writes a file contained within the dropper to common execution paths (e.g. c:\Windows\system32) and executes it.
- **Downloader**: Retrieves a file from an server.
- **Injector**: - Writes code directly into another process (e.g. explorer.exe) and creates a new thread in that process.

## Persistence

Once malicious code is executed, it's common to establish persistence in order to allow the malware to restart after a reboot, crash, or process kill. Windows has many options for automatic code execution including:

- Startup folder in the Start Menu
- run registry keys
    - e.g. `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- Services
- Active Setup/Installed Components
    - allowing per user-customization of startup events
- DLL Load-Order exploitation
- Scheduled Tasks

The [ATT&CK Framework](https://attack.mitre.org/) has a *Persistence* category with more examples.

On Windows, use the SysInternals/Microsoft [AutoRuns tool](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns) to see many more.

## Goals

Ultimately we want to understand how the code executes on reboot (assuming it does), but more specifically we want to:

- Find the Payload of the launcher
- Identify Registry Keys used
- Track malicious code injection into other processes
- Determine if a Mutex is used
    - A mutex is used to prevent duplicate processes
    - Might be leveraged to search a network for infections

## Droppers

Droppers very often copy themselves to another location and behave differently once in their expected location (e.g. `C:\Windows\system32`). Other possibilities are:

- Global variables in the data or code sections
- Binary data in the Resource Section (RSRC) of the

## Downloaders

Downloads may use a variety of network functions and protocols to retrieve their payloads, and may even use encryption or chunk modification/reordering to fool Intrusion Detection Systems (IDS). Some common Network libraries and functions used are:

- Winsock2 (`ws2_32.dll`)
- WinInet (`wininet.dll`)
- URL Monikers (`urlmon.dll`)

## Injectors

Malicious processes can stick out like a sore thumb. Even the cleverly named processed like scvhost.exe are noticeable to the well trained analyst. DLL Injection is less noticeable, and shellcode injection is even more stealthy, though the calls to perform it may raise alarms as it is unusual behavior. They include:

- `OpenProcess`
- `VirtualAllocEx`
- `WriteProcessMemory`
- `CreateRemoteThread`

This may be preceded by calls to the following functions used to iterate the running process in order to locate a target (e.g. explorer.exe):

- `CreateToolhelp32Snapshot`
- `Process32First`
- `Process32Next`

### Common inject steps

1. Build a Payload Buffer
    - Often reads directly out of data our resource
    - May be code, but possibly a string
1. Select a target process
    - May be a search for a paritcular process name (e.g. explorer.exe)
1. Create or access a memory region in the target process
    - Write the payload to this region (WriteProcessMemory)
1. Create a thread in the target process (CreateRemoteThread)
    - Requires a target process, address to start execution, and pointer to parameters
    - start address often a location in the payload, though at times an API location
        - `LoadLibrary` for DLL Injection

### Intercepting

- Could replace entry byte with 0xCC (INT 3/breakpoint)
- Could alter the process injected into.
    - Debugging notepad is much more stable than debugging explorer.exe!
- May wish to start process in a suspended state

Shellcode common characteristics:

- Position Independent (works "at any address")
    - Could dump code to a file for later analysis in disassembler
- Encoded and begins with a decoding loop
- Searches for library functions, loading libraries when necessary
